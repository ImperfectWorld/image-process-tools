/* image-process-tools | version: 2.2.1 | author: Capricorncd | 2017-10-30 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.IPTS=b():a.IPTS=b()}(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.i=function(a){return a},b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a.default}:function(){return a};return b.d(c,"a",c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p="",b(b.s=0)}([function(a,b,c){"use strict";function d(a){var b=this._checkParameter(a);if(b)return void(a.error&&a.error(b));this.btn=e(a.elm),this.fileInput=null,this.opts=a,this.init()}function e(a){return document.querySelector(a)||null}function f(a){var b=parseInt(a);return isNaN(b)?0:b}function g(a){return a.toString().split(".").pop().toLowerCase()}function h(a){var b=["png","jpg","jpeg","gif","webp","bmp"],c=g(a);return/(\w+)\?/.test(c)&&(c=RegExp.$1),b.indexOf(c)>-1}function i(a){var b=a.split(","),c="";return/data:(\w+\/\w+);base64/.test(b[0])&&(c=RegExp.$1),{type:c,data:b[1]}}function j(a,b){var c=i(a);a=window.atob(c.data),b=b||c.type;for(var d=new Uint8Array(a.length),e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return new Blob([d],{type:b})}function k(a,b){return parseInt(a/b*1e4)/1e4}function l(a,b){var c=document.createElement("canvas");return c.width=b.cw,c.height=b.ch,c.getContext("2d").drawImage(a,b.sx,b.sy,b.sw,b.sh,0,0,c.width,c.height),c}var m={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/jaeg",gif:"image/png",bmp:"image/jpeg"},n={0:"成功，程序正常完成整套流程，并返回最终结果",1:"选中的文件非图片文件，返回选中文件数据data"},o={1:"配置参数未配置或有误",2:"请配置图片选择按钮#id或.class",3:"浏览器不支持addEventListener()",4:"浏览器不支持FileReader接口！\n需升级或更换高版本的浏览器",5:"未选中文件",6:"选中的文件不是图片文件",7:"文件读取错误",8:"图片数据加载错误",9:"当前图片文件尺寸小于裁剪尺寸"},p=d.prototype;p._checkParameter=function(a){return!a instanceof Object?{code:1,msg:o[1]}:a.elm&&e(a.elm)?void 0:{code:2,msg:o[2]}},p.createFIleInput=function(){var a=document.createElement("input");a.setAttribute("type","file"),a.style.display="none",a.id="IPTS_"+(new Date).getTime(),this.btn.parentNode.appendChild(a),this.fileInput=a},p.triggerFileInput=function(){var a=this;this.btn.addEventListener?this.btn.addEventListener("click",function(b){var c=new MouseEvent("click",{bubbles:!1,cancelable:!0,view:window});a.fileInput.dispatchEvent(c)},!1):this.opts.error&&this.opts.error({code:3,msg:o[3]})},p.getFileData=function(a){function b(b,d){var e=new Image;e.src=b,e.setAttribute("alt",d.name),e.onload=function(c){a&&a({element:e,data:b,width:e.width,height:e.height,type:d.type,size:d.size})},e.onerror=function(a){c.opts.error&&c.opts.error({code:8,msg:o[8]})}}var c=this;if("undefined"==typeof FileReader)return void(this.opts.error&&this.opts.error({code:4,msg:o[4]}));this.fileInput.addEventListener("change",function(a){var d=this.files[0];if(!d)return void(c.opts.error&&c.opts.error({code:5,msg:o[5]}));if(!h(d.name))return c.opts.success&&c.opts.success({code:1,msg:n[1],data:d}),void(c.opts.error&&c.opts.error({code:6,msg:o[6]}));var e=new FileReader;e.readAsDataURL(d),e.onload=function(a){b(this.result,d)},e.onerror=function(a){c.opts.error&&c.opts.error({code:7,msg:o[7]})}},!1)},p.handleImageData=function(a,b){var c=this.opts,d=c.type?c.type.toLowerCase():null,e=d&&m[d]?m[d]:a.type;c.progress&&c.progress(0);var f=this.calculateCropInfo(a.width,a.height),g=a.element,h=2,i=f.sw,k=f.sh,n=f.sx,o=f.sy;if(f.scaling>h){h=f.scaling;do{c.progress&&c.progress(2/h),g=l(g,{cw:f.cw*h,ch:f.ch*h,sx:n,sy:o,sw:i,sh:k}),i=g.width,k=g.height,n=o=0,h-=1}while(h>2)}g=l(g,{cw:f.cw,ch:f.ch,sx:n,sy:o,sw:i,sh:k});var p=g.toDataURL(e);p=j(p,e),c.progress&&c.progress(1),b&&b({code:0,msg:"Completed",element:g,type:e,width:f.cw,height:f.ch,data:p,size:p.size,rawdata:a})},p.calculateCropInfo=function(a,b){var c=this.opts,d="boolean"==typeof c.crop&&c.crop,e=f(c.width),g=f(c.height);(a<e||b<g)&&c.error&&c.error({code:9,msg:o[9]});var h=1,i=0,j=0,l=a,m=b,n=0,p=0;return d&&e>0&&g>0?(l=e,m=g,n=e,p=Math.floor(e*b/a),h=k(a,e),p>=g?(i=0,j=f((p-g)/2*h)):(n=Math.floor(g*a/b),p=g,i=f((n-e)/2*h),j=0,h=k(b,g))):e>0?(l=e,m=Math.floor(e*b/a),h=k(a,e)):g>0&&(l=Math.floor(g*a/b),m=g,h=k(b,g)),{sx:i,sy:j,sw:f(l*h),sh:f(m*h),scaling:h,cw:l,ch:m}},p.conversion=function(a){var b=f(f(a)/1024*100)/100;return b>=1024?f(b/1024*100)/100+"M":b+"KB"},p.init=function(){var a=this;this.createFIleInput(),this.triggerFileInput(),this.getFileData(function(b){a.handleImageData(b,function(b){var c=e(a.opts.target);c&&(c.innerHTML="",c.appendChild(b.element)),a.opts.success&&a.opts.success(b)})})},a.exports=d}])});