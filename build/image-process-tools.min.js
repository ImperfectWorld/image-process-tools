/* image-process-tools | version: 2.0.0 | author: Capricorncd | 2017-06-06 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.IPTS=b():a.IPTS=b()}(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.i=function(a){return a},b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a.default}:function(){return a};return b.d(c,"a",c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p="",b(b.s=0)}([function(a,b,c){"use strict";function d(a){var b=this;if(!a instanceof Object)return a.error&&a.error({code:1,msg:"配置参数未配置或有误！"}),alert("配置参数未配置或有误！"),!1;this.options=a;var c=null,d=null,g=!1,h=0,i=0,j=null;if(!a.elm)return a.error&&a.error({code:1,msg:"请配置图片选择按钮id！"}),alert("请配置图片选择按钮id！"),!1;c=a.elm,a.target&&(d=a.target),a.crop&&(g=!0),a.width&&(h=parseInt(a.width),h=isNaN(h)?0:h),a.height&&(i=parseInt(a.height),i=isNaN(i)?0:i),a.type&&f[a.type]&&(j=f[a.type]);var k="IPTS_"+(new Date).getTime();this.createFileInput(c,k),this.readImageFileData(k,function(c){var f={isCrop:g,width:h,height:i,type:j};b.resize(c,f,function(c){d&&(e(d).innerHTML="",e(d).appendChild(c.node)),a.success&&a.success({code:0,data:b.toBlobData(c.data,c.type)})})})}function e(a){return document.getElementById(a)}var f={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/png",bmp:"image/jpeg"};d.prototype.createFileInput=function(a,b){var c=e(a),d=document.createElement("input");d.setAttribute("type","file"),d.style.display="none",d.id=b,c.parentNode.appendChild(d),this.selectFile(c,d)},d.prototype.selectFile=function(a,b){if(!a.addEventListener)return options.error&&options.error({code:1,msg:"您的浏览器不支持addEventListener！"}),alert("您的浏览器不支持addEventListener！"),!1;a.addEventListener("click",function(a){var c=new MouseEvent("click",{bubbles:!1,cancelable:!0,view:window});b.dispatchEvent(c)},!1)},d.prototype.readImageFileData=function(a,b){return void 0===typeof FileReader?(alert("您的浏览器不支持FileReader接口！\n请升级或更换高版本浏览器！"),!1):e(a).addEventListener?void e(a).addEventListener("change",function(a){var c=a.target.files[0];if(!c)return console.log("未选中文件！"),!1;var d=new FileReader,e=new Image;d.readAsDataURL(c),d.onload=function(a){e.src=a.target.result,e.setAttribute("alt",c.name),b(e)}},!1):(alert("浏览器版本过低！"),!1)},d.prototype.resize=function(a,b,c){var d=this,e=!0;if(!b instanceof Object)return this.options.error&&this.options.error({code:1,msg:"resize(img, params, callback)参数错误！"}),!1;a.onload=function(g){e=!1;var h=a.width,i=a.height;b.iw=h,b.ih=i;var j="";if(b.type)j=b.type;else{var k=d.getFileSuffix(a.alt);j=f[k]?f[k]:"image/jpeg"}if(h===b.width&&i===b.height)return c({code:0,msg:"img尺寸与裁剪目标尺寸相同",node:a,data:a.src,type:j}),!1;var l=d.calculateNewData(b),m=document.createElement("canvas");m.width=l.cw,m.height=l.ch,m.getContext("2d").drawImage(a,l.sx,l.sy,l.sw,l.sh,0,0,l.cw,l.ch);var n=m.toDataURL(j);c({code:0,msg:"success",node:m,data:n,type:j})};var g=setTimeout(function(){e&&d.options.error&&d.options.error({code:1,msg:"resize()超时, img.onload()未执行！",node:a,data:null,type:null}),clearTimeout(g)},5e3)},d.prototype.calculateNewData=function(a){var b=a.isCrop,c=1,d=a.width,e=a.height,f=a.iw,g=a.ih,h=0,i=0,j=f,k=g;if(b&&d>0&&e>0){j=d,k=e;var l,m;l=d,m=Math.floor(d*g/f),c=this._ratio(f,d),m>e?(h=0,i=parseInt((m-e)/2*c)):(l=Math.floor(e*f/g),m=e,h=parseInt((l-d)/2*c),i=0,c=this._ratio(g,e))}else d>0?(j=d,k=Math.floor(d*g/f),c=this._ratio(f,d)):e>0?(j=Math.floor(e*f/g),k=e,c=this._ratio(g,e)):(j=f,k=g);return{sx:h,sy:i,sw:parseInt(j*c),sh:parseInt(k*c),cw:j,ch:k}},d.prototype._ratio=function(a,b){return parseInt(a/b*1e4)/1e4},d.prototype.toBlobData=function(a,b){a=a.split(",")[1],a=window.atob(a);for(var c=new Uint8Array(a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return new Blob([c],{type:b})},d.prototype.getFileSuffix=function(a){return a.toString().split(".").pop().toLowerCase()},a.exports=d}])});