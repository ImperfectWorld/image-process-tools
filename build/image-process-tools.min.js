/* image-process-tools | version: 2.1.0 | author: Capricorncd | 2017-07-01 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.IPTS=b():a.IPTS=b()}(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.i=function(a){return a},b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a.default}:function(){return a};return b.d(c,"a",c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p="",b(b.s=0)}([function(a,b,c){"use strict";function d(a){var b=this;if(!a instanceof Object)return a.error&&a.error({code:1,msg:"配置参数未配置或有误！"}),!1;if(!a.elm||"string"!=typeof a.elm)return a.error&&a.error({code:1,msg:"请配置图片选择按钮id！"}),!1;this.options=a;var c="IPTS_"+Date.parse(new Date);this._createFileInput(a.elm,c),this.readImageFileData(c,function(c){b.getCropImageData(c,function(b){var c=a.target;c&&(e(c).innerHTML="",e(c).appendChild(b.element)),a.success&&a.success(b)})})}function e(a){return document.getElementById(a)}function f(a){var b=parseInt(a);return isNaN(b)?0:b}var g={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/jaeg",gif:"image/png",bmp:"image/jpeg"},h=d.prototype;h._createFileInput=function(a,b){var c=e(a),d=document.createElement("input");d.setAttribute("type","file"),d.style.display="none",d.id=b,c.parentNode.appendChild(d),this._selectFile(c,d)},h._selectFile=function(a,b){a.addEventListener?a.addEventListener("click",function(a){var c=new MouseEvent("click",{bubbles:!1,cancelable:!0,view:window});b.dispatchEvent(c)},!1):this.options.error&&this.options.error({code:1,msg:"您的浏览器不支持addEventListener！"})},h.readImageFileData=function(a,b){var c=this;return"undefined"==typeof FileReader?(this.options.error&&this.options.error({code:1,msg:"您的浏览器不支持FileReader接口！\n请升级或更换高版本浏览器！"}),!1):e(a).addEventListener?void e(a).addEventListener("change",function(a){var d=a.target.files[0];if(!d)return void(c.options.error&&c.options.error({code:1,msg:"未选中文件"}));if(!c.isImage(d.name))return void(c.options.error&&c.options.error({code:1,msg:"只支持图片文件，请重新选择"}));var e=new FileReader,f=new Image;e.readAsDataURL(d),e.onload=function(a){f.src=a.target.result,f.setAttribute("alt",d.name),c._getImageInfo(f,function(a){b&&b(a)})},e.onerror=function(a){c.options.error&&c.options.error({code:1,msg:"文件读取错误"})}},!1):(c.options.error&&c.options.error({code:1,msg:"浏览器版本过低，不支持addEventListener"}),!1)},h._getImageInfo=function(a,b){var c=this;a.onload=function(d){var e=a.src;b&&b({element:a,width:a.width,height:a.height,type:c.getBase64Info(e).type,data:e,size:c.toBlobData(e).size})},a.onerror=function(a){c.options.error&&c.options.error({code:1,msg:"图片数据加载错误"})}},h.getCropImageData=function(a,b){var c=this.options.type?this.options.type.toLowerCase():null,d=c&&g[c]?g[c]:a.type,e=this._calculateNewData({width:a.width,height:a.height}),f=document.createElement("canvas");f.width=e.cw,f.height=e.ch,f.getContext("2d").drawImage(a.element,e.sx,e.sy,e.sw,e.sh,0,0,e.cw,e.ch);var h=f.toDataURL(d);h=this.toBlobData(h,d),b({code:0,msg:"Completed",element:f,type:d,width:e.cw,height:e.ch,data:h,size:h.size,rawdata:a})},h._calculateNewData=function(a){var b=this.options,c=a.width,d=a.height,e=f(b.width),g=f(b.height);(c<e||d<g)&&this.options.error&&this.options.error({code:2,msg:"当前图片文件尺寸小于裁剪尺寸"});var h="boolean"==typeof b.crop&&b.crop,i=1,j=0,k=0,l=c,m=d,n=0,o=0;return h&&e>0&&g>0?(l=e,m=g,n=e,o=Math.floor(e*d/c),i=this._ratio(c,e),o>=g?(j=0,k=f((o-g)/2*i)):(n=Math.floor(g*c/d),o=g,j=f((n-e)/2*i),k=0,i=this._ratio(d,g))):e>0?(l=e,m=Math.floor(e*d/c),i=this._ratio(c,e)):g>0?(l=Math.floor(g*c/d),m=g,i=this._ratio(d,g)):(l=c,m=d),{sx:j,sy:k,sw:f(l*i),sh:f(m*i),cw:l,ch:m}},h._ratio=function(a,b){return parseInt(a/b*1e4)/1e4},h.toBlobData=function(a,b){var c=this.getBase64Info(a);a=window.atob(c.data),b=b||c.type;for(var d=new Uint8Array(a.length),e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return new Blob([d],{type:b})},h.getBase64Info=function(a){var b=a.split(","),c="";return/data:(\w+\/\w+);base64/.test(b[0])&&(c=RegExp.$1),{type:c,data:b[1]}},h.isImage=function(a){var b=["png","jpg","jpeg","gif","webp","bmp"],c=this.getFileSuffix(a);return b.join(",").indexOf(c)>-1},h.getFileSuffix=function(a){return a.toString().split(".").pop().toLowerCase()},h.conversion=function(a){a=f(a);var b=f(a/1024*100)/100;return b>=1024?f(b/1024*100)/100+"M":b+"KB"},a.exports=d}])});