/* image-process-tools | version: 2.1.0 | author: Capricorncd | 2017-09-14 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.IPTS=b():a.IPTS=b()}(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.i=function(a){return a},b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a.default}:function(){return a};return b.d(c,"a",c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p="",b(b.s=0)}([function(a,b,c){"use strict";function d(a){var b=this;if(!a instanceof Object)return void(a.error&&a.error({code:1,msg:i[1]}));if(!a.elm||"string"!=typeof a.elm)return void(a.error&&a.error({code:2,msg:i[2]}));this.opts=a;var c="IPTS_"+(new Date).getTime();this._createFileInput(a.elm,c),this.readImageFileData(c,function(c){b.handleImageData(c,function(b){var c=a.target;c&&(e(c).innerHTML="",e(c).appendChild(b.element)),a.success&&a.success(b)})})}function e(a){return document.getElementById(a)}function f(a){var b=parseInt(a);return isNaN(b)?0:b}var g={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/jaeg",gif:"image/png",bmp:"image/jpeg"},h={0:"成功，程序正常完成整套流程，并返回最终结果",1:"选中的文件非图片文件，返回选中文件数据data"},i={1:"配置参数未配置或有误",2:"配置图片选择按钮id",3:"浏览器不支持addEventListener()",4:"浏览器不支持FileReader接口！\n需升级或更换高版本的浏览器",5:"未选中文件",6:"选中的文件不是图片文件",7:"文件读取错误",8:"图片数据加载错误",9:"当前图片文件尺寸小于裁剪尺寸"},j=d.prototype;j._createFileInput=function(a,b){var c=e(a),d=document.createElement("input");d.setAttribute("type","file"),d.style.display="none",d.id=b,c.parentNode.appendChild(d),this._selectFile(c,d)},j._selectFile=function(a,b){a.addEventListener?a.addEventListener("click",function(a){var c=new MouseEvent("click",{bubbles:!1,cancelable:!0,view:window});b.dispatchEvent(c)},!1):this.opts.error&&this.opts.error({code:3,msg:i[3]})},j.readImageFileData=function(a,b){var c=this;if("undefined"==typeof FileReader)return void(this.opts.error&&this.opts.error({code:4,msg:i[4]}));e(a).addEventListener?e(a).addEventListener("change",function(a){var d=this.files[0];if(!d)return void(c.opts.error&&c.opts.error({code:5,msg:i[5]}));if(!c.isImage(d.name))return c.opts.success&&c.opts.success({code:1,msg:h[1],data:d}),void(c.opts.error&&c.opts.error({code:6,msg:i[6]}));var e=new FileReader,f=new Image;e.readAsDataURL(d),e.onload=function(a){f.src=this.result,f.setAttribute("alt",d.name),c._getImageInfo(f,b)},e.onerror=function(a){c.opts.error&&c.opts.error({code:7,msg:i[7]})}},!1):c.opts.error&&c.opts.error({code:3,msg:i[3]})},j.handleImageData=function(a,b){var c=this.opts.type?this.opts.type.toLowerCase():null,d=c&&g[c]?g[c]:a.type;this.opts.progress&&this.opts.progress(0);var e=this.calculateCropInfo(a.width,a.height),f=a.element,h=2,i=e.sw,j=e.sh,k=e.sx,l=e.sy;if(e.scaling>h){h=e.scaling;do{this.opts.progress&&this.opts.progress(2/h),f=this.createCanvas(f,{cw:e.cw*h,ch:e.ch*h,sx:k,sy:l,sw:i,sh:j}),i=f.width,j=f.height,k=l=0,h-=1}while(h>2)}f=this.createCanvas(f,{cw:e.cw,ch:e.ch,sx:k,sy:l,sw:i,sh:j});var m=f.toDataURL(d);m=this.toBlobData(m,d),this.opts.progress&&this.opts.progress(1),b&&b({code:0,msg:"Completed",element:f,type:d,width:e.cw,height:e.ch,data:m,size:m.size,rawdata:a})},j.createCanvas=function(a,b){var c=document.createElement("canvas");return c.width=b.cw,c.height=b.ch,c.getContext("2d").drawImage(a,b.sx,b.sy,b.sw,b.sh,0,0,c.width,c.height),c},j._getImageInfo=function(a,b){var c=this;a.onload=function(d){var e=a.src;b&&b({element:a,width:a.width,height:a.height,type:c.getBase64Info(e).type,data:e,size:c.toBlobData(e).size})},a.onerror=function(a){c.opts.error&&c.opts.error({code:8,msg:i[8]})}},j.calculateCropInfo=function(a,b){var c=this.opts,d="boolean"==typeof c.crop&&c.crop,e=f(c.width),g=f(c.height);(a<e||b<g)&&this.opts.error&&this.opts.error({code:9,msg:i[9]});var h=1,j=0,k=0,l=a,m=b,n=0,o=0;return d&&e>0&&g>0?(l=e,m=g,n=e,o=Math.floor(e*b/a),h=this._ratio(a,e),o>=g?(j=0,k=f((o-g)/2*h)):(n=Math.floor(g*a/b),o=g,j=f((n-e)/2*h),k=0,h=this._ratio(b,g))):e>0?(l=e,m=Math.floor(e*b/a),h=this._ratio(a,e)):g>0&&(l=Math.floor(g*a/b),m=g,h=this._ratio(b,g)),{sx:j,sy:k,sw:f(l*h),sh:f(m*h),scaling:h,cw:l,ch:m}},j._ratio=function(a,b){return parseInt(a/b*1e4)/1e4},j.toBlobData=function(a,b){var c=this.getBase64Info(a);a=window.atob(c.data),b=b||c.type;for(var d=new Uint8Array(a.length),e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return new Blob([d],{type:b})},j.getBase64Info=function(a){var b=a.split(","),c="";return/data:(\w+\/\w+);base64/.test(b[0])&&(c=RegExp.$1),{type:c,data:b[1]}},j.isImage=function(a){var b=["png","jpg","jpeg","gif","webp","bmp"],c=this.getFileSuffix(a);return/(\w+)\?/.test(c)&&(c=RegExp.$1),b.indexOf(c)>-1},j.getFileSuffix=function(a){return a.toString().split(".").pop().toLowerCase()},j.conversion=function(a){var b=f(f(a)/1024*100)/100;return b>=1024?f(b/1024*100)/100+"M":b+"KB"},a.exports=d}])});